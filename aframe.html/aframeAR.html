<!DOCTYPE html>
<html>
<head>
  <title>Aframe</title>
  <script src="../aframe/aframe.min.js"></script>
  <script src='../three/js/libs/inflate.min.js'></script>
  <script src="../three/build/three.js"></script>
  <script src="../three/js/controls/TrackballControls.js"></script>
  <script src="../three/js/loaders/VTKLoader.js"></script>
  <script src="../three/js/Detector.js"></script>
  <script src="../three/js/libs/stats.min.js"></script>  <meta charset="utf-8">
  <script src="../aframe/aframe-ar.js"></script>
  <script src="../js/jquery.min.js"></script>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script type="text/javascript">d4 = d3</script>
  <script src="../js/d3.v3.min.js" charset="utf-8"></script>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
  <script src="../bootstrap/js/jquery-3.2.1.slim.min.js"></script>
  <script src="../bootstrap/js/popper.min.js"></script>
  <script src="../bootstrap/js/bootstrap.min.js"></script>

<style>

.button {
    background-color: #4CAF50; /* Green */
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
}

#a-scene {
  position: absolute;
}
#canvas {
  position: absolute;
  background-color:lightgrey
}
#button {
  position:absolute;
  left:0%;
  top:0%;
  z-index: 1;
}

.navbarrie {
  position:absolute;
  background-color: rgba(0,0,0,0.5);
  top:0%;
  z-index: 1;
}
.navbar-brand {
  color: rgba(255, 255, 255, 0.9) !important;
}
.dropdown-menu {
  background-color: rgba(0,0,0,0);
  color: rgba(255, 255, 255, 0.9) !important;
  border: 0px solid rgba(0,0,0,0.5);
  padding: 0;
}
.navbar {
  color:white;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis text {
  font: 10px sans-serif;
}

#s .tick:last-of-type text,
#l .tick:last-of-type text {
  display: none;
}

.channel canvas {
  float: left;
  margin: 40px 30px 0 30px;
  width: 900px;
  height: 90px;
}
.aspectwrapper {
  display: inline-block; /* shrink to fit */
  width: 100%;           /* whatever width you like */
  position: relative;    /* so .content can use position: absolute */
}
.aspectwrapper::after {
  padding-top: 56.25%; /* percentage of containing block _width_ */
  display: block;
  content: '';
}
.content {
  position: absolute;
  top: 0; bottom: 0; right: 0; left: 0;  /* follow the parent's edges */
  outline: thin dashed green;            /* just so you can see the box */
}

.slider {
  position: relative;
  top: 40px;
  left: 40px;
}

.slider-tray {
  position: absolute;
  width: 100%;
  height: 6px;
  border: solid 1px #ccc;
  border-top-color: #aaa;
  border-radius: 4px;
  background-color: #f0f0f0;
  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.08);
}

.slider-handle {
  position: absolute;
  top: 3px;
}

.slider-handle-icon {
  width: 14px;
  height: 14px;
  border: solid 1px #aaa;
  position: absolute;
  border-radius: 10px;
  background-color: #fff;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
  top: -7px;
  left: -7px;
}

</style>
</head>
<body>
<div class="col-md-12 navbarrie">
<nav class="navbar navbar-toggleable-md navbar-dark bg-faded">
  <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="#">Pierre</a>
  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" onmouseover="" style="cursor: pointer;" onclick="backToDefault()">Default</a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" onmouseover="" style="cursor: pointer;">
          BodyParts
        </a>
        <div class="dropdown-menu col-md-6" aria-labelledby="navbarDropdownMenuLink">
          <table class="table">
            <tbody>
              <tr>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Skin')">Skin</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Blood')">Blood</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Brain')">Brain</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Duodenum')">Duodenum</td>
              </tr>
              <tr>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('EyeRetina')">Eye Retina</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('EyeWhite')">Eye White</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Heart')">Heart</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Ileum')">Ileum</td>
              </tr>
              <tr>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Kidney')">Kidney</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('LargeIntestine')">Large Intestine</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Liver')">Liver</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Lung')">Lung</td>
              </tr>
              <tr>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Nerve')">Nerve</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Skeleton')">Skeleton</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Spleen')">Spleen</td>
                <td data-toggle="dropdown" data-target=".coloring" onmouseover="" style="cursor: pointer;" onclick="change_organ('Stomach')">Stomach</td>
              </tr>
            </tbody>
          </table>
        </div>
      </li>
      <li class="nav-item dropdown coloring">
        <a class="nav-link dropdown-toggle clickable" id="navbarDropdownMenuLink_color" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" onmouseover="" style="cursor: pointer;">
          Coloring
        </a>
        <div class="dropdown-menu col-md-6" aria-labelledby="navbarDropdownMenuLink_color">
          <div class="aspectwrapper">
          <button id="color_now" class="button" type="button" onclick="apply_coloration()">Apply</button>
          <div class="channel" id="h">
            <canvas width="900" height="1"></canvas>
            <svg width="960" height="20"><g class="axis" transform="translate(30,.5)"></g></svg>
          </div>
          <div class="channel" id="s">
            <canvas width="900" height="1"></canvas>
            <svg width="960" height="20"><g class="axis" transform="translate(30,.5)"></g></svg>
          </div>
          <div class="channel" id="l">
            <canvas width="900" height="1"></canvas>
            <svg width="960" height="20"><g class="axis" transform="translate(30,.5)"></g></svg>
          </div>
          <div class="slider"></div>
          </div>
        </div>
      </li>
    </div>
  </div>
  </nav>
  </div>

  <a-scene embedded arjs="trackingMethod: best;">
    <a-anchor hit-testing-enabled='true'>
      <a-entity style="opacity:0.5;"></a-entity>
    </a-anchor>
    <a-camera-static/>
  </a-scene>

  <script>
    var meshesh = {};
    var coloring = "hsl(180, 50% , 50% )";
    var opacity = 100;
    var organ = "skeleton";
    var color_codes = {"Skeleton" : 0xf0f0f0, "Stomach" : 0x858500};
    var organs = Object.keys(color_codes);
    var mesh;

    var white = d3.rgb("white"),
      black = d3.rgb("black"),
      width = d3.select("canvas").property("width");

    var channels = {
      h: {scale: d3.scale.linear().domain([0, 360]).range([0, width]), x: width / 2},
      s: {scale: d3.scale.linear().domain([0, 1]).range([0, width]), x: width / 2},
      l: {scale: d3.scale.linear().domain([0, 1]).range([0, width]), x: width / 2}
    };

    $('li.coloring').on('click', function(event){
      var events = $._data(document, 'events') || {};
      events = events.click || [];
      for(var i = 0; i < events.length; i++) {
        if(events[i].selector) {
          //Check if the clicked element matches the event selector
          if($(event.target).is(events[i].selector)) {
              events[i].handler.call(event.target, event);
          }

          // Check if any of the clicked element parents matches the 
          // delegated event selector (Emulating propagation)
          $(event.target).parents(events[i].selector).each(function(){
              events[i].handler.call(this, event);
          });
        }
      }
      event.stopPropagation(); //Always stop propagation
    });

    init();

    function init() {
      var scene = document.querySelector('a-entity').object3D;

      var beeybeey;
      var rot = { x: 90, y: 0, z: 0 };
      var scale = 0.002;

      var loader1 = new THREE.VTKLoader();
      loader1.load( '../vtkaas/pierre_t_s_d.vtk', function ( geometry ) {

        geometry.computeVertexNormals();
        geometry.center();
        beeybeey = geometry.boundingBox.min;

        var material = new THREE.MeshLambertMaterial( { color: 0xf0f0f0, side: THREE.DoubleSide } );
        var mesh = new THREE.Mesh( geometry, material );
        meshesh["Skeleton"] = mesh;

        mesh.position.set( 0, 0, 0 );
        mesh.scale.multiplyScalar( scale );
        rotateObject( mesh, rot.x, rot.y , rot.z );

        scene.add( mesh );

        load_vtk('../vtkaas/pierre_t_s_d_stomach.vtk', scene, rot, scale, beeybeey, 0x858500, 1, "Stomach");

      });
    }

    function load_vtk(fileName, scene, rot, scale, beeybeey, color, opacity, index) {
      var loader = new THREE.VTKLoader();

      loader.load( fileName, function ( geometry ) {

        geometry.computeVertexNormals();
        geometry.translate(beeybeey.x, beeybeey.y, beeybeey.z);

        var material = new THREE.MeshLambertMaterial( { color: color, opacity: opacity, side: THREE.DoubleSide } );
        var mesh = new THREE.Mesh( geometry, material );
        meshesh[index] = mesh;

        mesh.position.set( 0, 0, 0 );
        mesh.scale.multiplyScalar( scale );
        rotateObject( mesh, rot.x, rot.y, rot.z );

        scene.add( mesh );
      });

      return beeybeey ;
    }

    function rotateObject(object,degreeX=0, degreeY=0, degreeZ=0) {
      degreeX = (degreeX * Math.PI) / 180;
      degreeY = (degreeY * Math.PI) / 180;
      degreeZ = (degreeZ * Math.PI) / 180;

      object.rotateX(degreeX);
      object.rotateY(degreeY);
      object.rotateZ(degreeZ);
    }

    function backToDefault() {
      for (var i = organs.length - 1; i >= 0; i--) {
        meshesh[organs[i]].material.color = new THREE.Color(color_codes[organs[i]]);
        meshesh[organs[i]].material.needsUpdate = true;
      }
    }

    function apply_coloration () {
      console.log(opacity);
      meshesh[organ].material.color = new THREE.Color(coloring);
      meshesh[organ].material.opacity = opacity;
      meshesh[organ].material.needsUpdate = true;
    }

    function change_organ(new_organ) {
      organ = new_organ;
    }

    var channel = d3.selectAll(".channel")
        .data(d3.entries(channels));

    channel.select(".axis")
        .each(function(d) { d3.select(this).call(d3.svg.axis().scale(d.value.scale).orient("bottom")).style("fill", "white"); })
      .append("text")
        .attr("x", width)
        .attr("y", 9)
        .attr("dy", ".72em")
        .style("text-anchor", "middle")
        .style("fill", "white")
        .style("text-transform", "uppercase")
        .text(function(d) { return d.key; });

    var canvas = channel.select("canvas")
        .call(d3.behavior.drag().on("drag", dragged))
        .each(render);

    function dragged(d) {
      d.value.x = Math.max(0, Math.min(this.width - 1, d3.mouse(this)[0]));
      canvas.each(render);
    }

    function render(d) {
      var width = this.width,
          context = this.getContext("2d"),
          image = context.createImageData(width, 1),
          i = -1;

      var current = d3.hsl(
        channels.h.scale.invert(channels.h.x),
        channels.s.scale.invert(channels.s.x),
        channels.l.scale.invert(channels.l.x)
      );

      d3.select("#color_now").style("background-color", "hsl(" + current.h + ", " + current.s * 100 + "% , " + current.l * 100 +"% )");
      coloring = "hsl(" + Math.round(current.h) + ", " + Math.round(current.s * 100) + "% , " + Math.round(current.l * 100) +"% )"

      for (var x = 0, v, c; x < width; ++x) {
        if (x === d.value.x) {
          c = white;
        } else if (x === d.value.x - 1) {
          c = black;
        } else {
          current[d.key] = d.value.scale.invert(x);
          c = d3.rgb(current);
        }
        image.data[++i] = c.r;
        image.data[++i] = c.g;
        image.data[++i] = c.b;
        image.data[++i] = 255;
      }
      context.putImageData(image, 0, 0);
    }

    var width = 500;

    var x = d3.scale.linear()
        .domain([1, 100])
        .range([0, width])
        .clamp(true);

    var dispatch = d3.dispatch("sliderChange");

    var slider = d3.select(".slider")
        .style("width", width + "px");

    var sliderTray = slider.append("div")
        .attr("class", "slider-tray");

    var sliderHandle = slider.append("div")
        .attr("class", "slider-handle");

    sliderHandle.append("div")
        .attr("class", "slider-handle-icon")

    slider.call(d3.behavior.drag()
        .on("dragstart", function() {
          dispatch.sliderChange(x.invert(d3.mouse(sliderTray.node())[0]));
          d3.event.sourceEvent.preventDefault();
        })
        .on("drag", function() {
          dispatch.sliderChange(x.invert(d3.mouse(sliderTray.node())[0]));
        }));

    dispatch.on("sliderChange.slider", function(value) {
      d3.select("#color_now").style("opacity", x(value) / width);
      opacity = x(value) / width;
      sliderHandle.style("left", x(value) + "px")
    });

  </script>
</body>
</html>
